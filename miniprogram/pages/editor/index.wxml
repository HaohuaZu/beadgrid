<view class="editor-page">

  <view class="editor-top-wrap">
    <view class="editor-top-row">
      <view class="size-chip size-chip-clickable" catchtap="handleTapSizeChip">
        {{gridSizeText}}
        <text class="size-chip-arrow">▾</text>
      </view>
      <view class="gesture-tip">双指缩放</view>
      <view class="top-history-actions">
        <view
          class="top-history-btn {{!canUndo ? 'is-disabled' : ''}}"
          catchtap="handleTopUndo"
        >
          <text class="top-history-icon">↶</text>
          <text class="top-history-text">撤</text>
        </view>
        <view
          class="top-history-btn {{!canRedo ? 'is-disabled' : ''}}"
          catchtap="handleTopRedo"
        >
          <text class="top-history-icon">↷</text>
          <text class="top-history-text">重</text>
        </view>
      </view>
      <view class="editor-top-actions">
        <view class="top-action-btn bead-mode-btn" bindtap="handleEnterBeadMode">开始拼豆</view>
        <view class="top-action-btn export-btn" bindtap="handleSaveExport">保存/导图</view>
      </view>
    </view>
  </view>
  <view wx:if="{{showEdgePicker}}" class="edge-picker-mask" bindtap="handleCloseEdgePicker"></view>
  <view wx:if="{{showEdgePicker}}" class="edge-picker-float brand-panel" catchtap="noop">
    <view class="edge-picker-title">设置图案最大边长</view>
    <view class="edge-picker-sub">选择预设，或输入自定义（10-200）</view>
    <view class="edge-picker-grid">
      <block wx:for="{{edgePresetList}}" wx:key="value">
        <view
          class="edge-picker-chip {{selectedEditorMaxEdge === item.value ? 'is-active' : ''}}"
          data-edge="{{item.value}}"
          bindtap="handleSelectEdgePreset"
        >
          {{item.label}}
        </view>
      </block>
    </view>
    <view class="edge-picker-actions">
      <view class="edge-picker-btn edge-picker-custom" bindtap="handleOpenCustomEdgeInput">自定义</view>
      <view class="edge-picker-btn edge-picker-close" bindtap="handleCloseEdgePicker">关闭</view>
    </view>
  </view>
  <view wx:if="{{viewMode === 'edit'}}" class="tool-rail brand-panel">
    <scroll-view class="tool-scroll" scroll-x="true" enable-flex="true" show-scrollbar="false">
      <view class="tool-inline">
        <view class="tool-chip {{currentTool === 'paint' ? 'is-active' : ''}}" data-tool="paint" bindtap="handleSwitchTool">
          <text class="tool-emoji">✎</text>
          <text>画笔</text>
        </view>
        <view class="tool-chip tool-erase {{currentTool === 'erase' ? 'is-active' : ''}}">
          <view class="tool-erase-main" data-tool="erase" bindtap="handleSwitchTool">
            <text class="tool-emoji">⌫</text>
            <text>{{eraserMode === 'flood' ? '大橡皮' : '橡皮'}}</text>
          </view>
          <view class="tool-erase-more" catchtap="handleToggleEraserMenu">▾</view>
        </view>
        <view class="tool-chip {{currentTool === 'pick' ? 'is-active' : ''}}" data-tool="pick" bindtap="handleSwitchTool">
          <text class="tool-emoji">◎</text>
          <text>取色</text>
        </view>
        <view class="tool-chip {{currentTool === 'bucket' ? 'is-active' : ''}}" data-tool="bucket" bindtap="handleSwitchTool">
          <text class="tool-emoji">▣</text>
          <text>油漆桶</text>
        </view>
        <view class="tool-chip tool-action" data-action="denoise" bindtap="handleQuickAction">
          <text class="tool-emoji">◇</text>
          <text>去杂色</text>
        </view>
        <view class="tool-chip tool-action" data-action="replaceColor" bindtap="handleQuickAction">
          <text class="tool-emoji">↺</text>
          <text>批量换色</text>
        </view>
        <view class="tool-chip tool-action tool-danger" data-action="clearCanvas" bindtap="handleQuickAction">
          <text class="tool-emoji">✕</text>
          <text>清空</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <view class="canvas-panel brand-panel">
    <view
      class="canvas-stage {{(showColorPicker || showBeadStatsOverlay || showEdgePicker || showExportPanel || showExportPreviewViewer) ? 'is-overlay-open' : ''}}"
      catchtouchmove="handleStageTouchMove"
    >
      <canvas
        id="editorCanvasNode"
        type="2d"
        canvas-id="editorCanvas"
        class="editor-canvas {{(showColorPicker || showBeadStatsOverlay || showEdgePicker || showExportPanel || showExportPreviewViewer) ? 'is-overlay-open' : ''}}"
        hidden="{{showColorPicker || showBeadStatsOverlay || showEdgePicker || showExportPanel || showExportPreviewViewer}}"
        width="{{canvasWidth}}"
        height="{{canvasHeight}}"
        catchtouchstart="handleCanvasTouchStart"
        catchtouchmove="handleCanvasTouchMove"
        catchtouchend="handleCanvasTouchEnd"
        catchtouchcancel="handleCanvasTouchEnd"
      ></canvas>
      <view wx:if="{{showScaleOverlay}}" class="scale-overlay">{{scaleText}}</view>
      <view wx:if="{{showMoveShapeOverlay}}" class="move-shape-overlay">{{moveShapeDeltaText}}</view>
      <view wx:if="{{!hasEditableGrid}}" class="canvas-empty">
        <text>暂未加载可编辑图纸</text>
        <text class="canvas-empty-sub">请返回创作页重新生成后再试</text>
      </view>
    </view>
  </view>

  <view class="view-tools-row brand-panel">
    <view class="view-tool-title">视图</view>
    <scroll-view class="view-tool-scroll" scroll-x="true" enable-flex="true" show-scrollbar="false">
      <view class="view-tool-inline">
        <view class="view-tool-chip {{currentTool === 'move' ? 'is-active' : ''}}" data-tool="move" bindtap="handleSwitchTool">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-drag-move-2-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '✥'}}</view>
          <text>拖拽</text>
        </view>
        <view class="view-tool-chip {{currentTool === 'moveShape' ? 'is-active' : ''}}" data-tool="moveShape" bindtap="handleSwitchTool">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-focus-3-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '⤢'}}</view>
          <text>移动图案</text>
        </view>
        <view class="view-tool-chip {{showGridLines ? 'is-active' : ''}}" data-action="toggleGrid" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-grid-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '#'}}</view>
          <text>网格</text>
        </view>
        <view class="view-tool-chip {{showColorCodeInEdit ? 'is-active' : ''}}" data-action="toggleColorCode" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-hashtag' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '◍'}}</view>
          <text>色号</text>
        </view>
        <view class="view-tool-chip {{showLocatorLines ? 'is-active' : ''}}" data-action="toggleLocator" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-crosshair-2-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '⊞'}}</view>
          <text>定位线</text>
        </view>
        <view class="view-tool-chip" data-action="mirror" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-flip-horizontal-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '⇋'}}</view>
          <text>镜像</text>
        </view>
        <view class="view-tool-chip" data-action="center" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-focus-2-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '◎'}}</view>
          <text>居中</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <view wx:if="{{viewMode === 'edit' && currentTool === 'moveShape'}}" class="move-shape-tip brand-panel">
    点击已填色格子后拖动，可整体移动图案
  </view>

  <view wx:if="{{viewMode === 'edit'}}" class="section-switch brand-panel">
    <view
      class="section-switch-btn {{bottomSectionTab === 'mard' ? 'is-active' : ''}}"
      data-tab="mard"
      bindtap="handleBottomSectionTab"
    >
      MARD ▾
    </view>
    <view
      class="section-switch-btn {{bottomSectionTab === 'stats' ? 'is-active' : ''}}"
      data-tab="stats"
      bindtap="handleBottomSectionTab"
    >
      色号统计
    </view>
    <view
      class="section-switch-btn {{bottomSectionTab === 'pick' ? 'is-active' : ''}}"
      data-tab="pick"
      bindtap="handleBottomSectionTab"
    >
      选色
    </view>
  </view>

  <view wx:if="{{viewMode === 'edit' && bottomSectionTab === 'mard'}}" class="palette-panel brand-panel">
    <view class="palette-head">
      <view class="palette-title">MARD221全实色</view>
      <view class="palette-type-btn">种类 ▾</view>
    </view>
    <scroll-view class="full-scroll" scroll-y="true" show-scrollbar="true">
      <view class="full-grid">
        <block wx:for="{{fullPalette}}" wx:key="index">
          <view
            class="full-item {{selectedColorIndex === item.index ? 'is-active' : ''}}"
            data-index="{{item.index}}"
            bindtap="handlePickColor"
          >
            <view class="full-dot" style="background: {{item.hex}};"></view>
            <text class="full-code">{{item.code}}</text>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <view wx:if="{{viewMode === 'edit' && beadStats.length && bottomSectionTab === 'stats'}}" class="editor-bead-panel brand-panel">
    <view class="editor-bead-head" bindtap="handleToggleBeadStats">
      <view class="editor-bead-title">色号统计（共 {{beadStats.length}} 种颜色）</view>
      <view class="editor-bead-toggle">展开 ▼</view>
    </view>
    <scroll-view class="editor-bead-preview-scroll" scroll-y="true" enable-flex="true" show-scrollbar="true">
      <view class="editor-bead-grid editor-bead-grid-preview">
        <block wx:for="{{beadStats}}" wx:key="index">
          <view
            class="editor-bead-item editor-bead-item-stat {{beadHighlightIndex === item.index ? 'is-active' : ''}}"
            data-index="{{item.index}}"
            bindtap="handleSelectBeadColor"
          >
            <view class="editor-bead-color" style="background: {{item.hex}}; color: {{item.textColor}};">
              <text class="editor-bead-color-code">{{item.code}}</text>
            </view>
            <text class="editor-bead-count">× {{item.count}}</text>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <view wx:if="{{viewMode === 'edit' && bottomSectionTab === 'pick'}}" class="pick-panel brand-panel">
    <view class="pick-panel-btn" bindtap="handleOpenColorPicker">
      <view class="pick-panel-dot" style="background: {{selectedColorHex}};"></view>
      <text class="pick-panel-text">选色 {{selectedColorCode}}</text>
      <text class="pick-panel-arrow">▾</text>
    </view>
  </view>

  <canvas
    canvas-id="exportCanvas"
    width="{{exportCanvasWidth}}"
    height="{{exportCanvasHeight}}"
    style="position: fixed; left: -9999px; top: -9999px; width: {{exportCanvasWidth}}px; height: {{exportCanvasHeight}}px;"
  ></canvas>

  <view wx:if="{{showExportPanel}}" class="export-panel-mask" bindtap="closeExportPanel">
    <view class="export-panel brand-panel" catchtap="noop">
      <view class="export-panel-head">
        <view>
          <view class="export-panel-title">保存和导图</view>
          <view class="export-panel-sub">支持导出高清图片，并可选择是否显示网格与色号。</view>
        </view>
        <view class="export-panel-close" bindtap="closeExportPanel">关闭</view>
      </view>

      <view class="export-panel-section">
        <view class="export-panel-label">导出内容</view>
        <view class="export-chip-row export-chip-row-wrap">
          <view
            class="export-chip export-chip-wide {{exportShowGrid ? 'is-active' : ''}}"
            data-key="exportShowGrid"
            bindtap="handleExportOptionToggle"
          >
            网格：{{exportShowGrid ? '显示' : '隐藏'}}
          </view>
          <view
            class="export-chip export-chip-wide {{exportShowCodes ? 'is-active' : ''}}"
            data-key="exportShowCodes"
            bindtap="handleExportOptionToggle"
          >
            色号：{{exportShowCodes ? '显示' : '隐藏'}}
          </view>
        </view>
      </view>

      <view class="export-preview-card">
        <view class="export-preview-head">
          <view class="export-preview-title">{{exportPreviewTitle}}</view>
          <view wx:if="{{exportPreviewBusy}}" class="export-preview-loading">生成中...</view>
        </view>
        <view class="export-preview-desc">{{exportPreviewDesc}}</view>
        <image
          wx:if="{{exportPreviewPath}}"
          class="export-preview-image"
          src="{{exportPreviewPath}}"
          mode="aspectFit"
          bindtap="handlePreviewExportImage"
        />
        <view wx:else class="export-preview-placeholder">
          <text>正在生成图片预览</text>
        </view>
        <view class="export-preview-hint">{{exportPanelHint}}</view>
        <view wx:if="{{exportLargeHint}}" class="export-preview-large-hint">{{exportLargeHint}}</view>
      </view>

      <view wx:if="{{exportProgressVisible}}" class="export-progress-wrap">
        <view class="export-progress-head">
          <view class="export-progress-text">{{exportProgressText || '导出中...'}}</view>
          <view class="export-progress-percent">{{exportProgressPercent}}%</view>
        </view>
        <view class="export-progress-track">
          <view class="export-progress-fill" style="width: {{exportProgressPercent}}%;"></view>
        </view>
      </view>

      <view class="export-panel-actions">
        <button class="export-panel-btn export-panel-btn-light" bindtap="handlePreviewExportImage">
          页面内预览
        </button>
        <button
          class="export-panel-btn export-panel-btn-primary"
          disabled="{{exportBusy}}"
          bindtap="handleExportConfirm"
        >
          {{exportPrimaryText}}
        </button>
      </view>
    </view>
  </view>

  <view wx:if="{{showExportPreviewViewer}}" class="export-viewer-mask" bindtap="closeExportPreviewViewer">
    <view class="export-viewer-panel brand-panel" catchtap="noop">
      <view class="export-viewer-head">
        <view class="export-viewer-title">高清预览</view>
        <view class="export-viewer-close" bindtap="closeExportPreviewViewer">关闭</view>
      </view>

      <view wx:if="{{exportViewerBusy}}" class="export-viewer-loading">
        正在生成高清预览...
      </view>

      <scroll-view
        wx:if="{{!exportViewerBusy && exportViewerPath}}"
        class="export-viewer-scroll"
        scroll-x="true"
        scroll-y="true"
        enable-flex="true"
        enhanced="true"
        show-scrollbar="true"
        fast-deceleration="true"
      >
        <view class="export-viewer-canvas">
          <image
            class="export-viewer-image"
            src="{{exportViewerPath}}"
            mode="widthFix"
            style="width: {{exportViewerImageWidth}}px;"
          />
        </view>
      </scroll-view>

      <view wx:if="{{!exportViewerBusy && !exportViewerPath}}" class="export-viewer-empty">暂无预览</view>

      <view class="export-viewer-footer">
        <view class="export-viewer-hint">{{exportViewerHint}}</view>
        <view class="export-viewer-zoom">
          <button class="export-viewer-zoom-btn" bindtap="handlePreviewZoomOut">缩小</button>
          <button class="export-viewer-zoom-btn" bindtap="handlePreviewZoomReset">重置</button>
          <button class="export-viewer-zoom-btn export-viewer-zoom-btn-primary" bindtap="handlePreviewZoomIn">放大</button>
          <view class="export-viewer-scale">{{exportViewerScaleText}}</view>
        </view>
      </view>
    </view>
  </view>

  <view wx:if="{{showBeadStatsOverlay}}" class="bead-stats-mask" bindtap="handleCloseBeadStatsOverlay">
    <view class="bead-stats-panel brand-panel" catchtap="noop">
      <view class="bead-stats-head">
        <view class="bead-stats-title">色号统计（共 {{beadStats.length}} 种颜色）</view>
        <view class="bead-stats-close" bindtap="handleCloseBeadStatsOverlay">关闭</view>
      </view>
      <scroll-view class="bead-stats-scroll" scroll-y="true" enable-flex="true" show-scrollbar="true">
        <view class="editor-bead-grid bead-stats-grid">
          <block wx:for="{{beadStats}}" wx:key="index">
            <view
              class="editor-bead-item editor-bead-item-full {{beadHighlightIndex === item.index ? 'is-active' : ''}}"
              data-index="{{item.index}}"
              bindtap="handleSelectBeadColor"
            >
              <view class="editor-bead-color" style="background: {{item.hex}}; color: {{item.textColor}};">
                <text class="editor-bead-color-code">{{item.code}}</text>
              </view>
              <text class="editor-bead-count">× {{item.count}}</text>
            </view>
          </block>
        </view>
      </scroll-view>
    </view>
  </view>

  <view wx:if="{{showColorPicker}}" class="color-picker-mask" bindtap="handleCloseColorPicker">
    <view class="color-picker-panel brand-panel" catchtap="noop">
      <view class="color-picker-title">选择颜色</view>
      <view class="color-picker-sub">已使用颜色</view>
      <scroll-view class="color-picker-used-scroll" scroll-x="true" enable-flex="true">
        <view class="used-row">
          <block wx:for="{{usedPalette}}" wx:key="index">
            <view
              class="color-chip {{selectedColorIndex === item.index ? 'is-active' : ''}}"
              data-index="{{item.index}}"
              bindtap="handlePickColor"
            >
              <view class="color-dot" style="background: {{item.hex}};"></view>
              <text class="color-code">{{item.code}}</text>
            </view>
          </block>
        </view>
      </scroll-view>
      <view class="color-picker-sub color-picker-sub-full">MARD221全实色</view>
      <scroll-view class="color-picker-full-scroll" scroll-y="true" show-scrollbar="true">
        <view class="full-grid">
          <block wx:for="{{fullPalette}}" wx:key="index">
            <view
              class="full-item {{selectedColorIndex === item.index ? 'is-active' : ''}}"
              data-index="{{item.index}}"
              bindtap="handlePickColor"
            >
              <view class="full-dot" style="background: {{item.hex}};"></view>
              <text class="full-code">{{item.code}}</text>
            </view>
          </block>
        </view>
      </scroll-view>
      <view class="color-picker-footer">
        <button class="color-picker-close-btn" bindtap="handleCloseColorPicker">关闭</button>
      </view>
    </view>
  </view>
</view>
