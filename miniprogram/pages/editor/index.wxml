<view class="editor-page">

  <view class="editor-top-wrap">
    <view class="editor-top-row">
      <view class="size-chip size-chip-clickable" bindtap="handleTapSizeChip">
        {{gridSizeText}}
        <text class="size-chip-arrow">▾</text>
      </view>
      <view class="gesture-tip">双指缩放</view>
      <view class="editor-top-actions">
        <view class="top-action-btn bead-mode-btn" bindtap="handleEnterBeadMode">开始拼豆</view>
        <view class="top-action-btn export-btn" bindtap="handleSaveExport">保存/导图</view>
      </view>
    </view>
    <view wx:if="{{showEdgePicker}}" class="edge-picker-panel brand-panel" catchtap="noop">
      <view class="edge-picker-title">设置图案最大边长</view>
      <view class="edge-picker-sub">选择预设，或输入自定义（10-200）</view>
      <view class="edge-picker-grid">
        <block wx:for="{{edgePresetList}}" wx:key="value">
          <view
            class="edge-picker-chip {{selectedEditorMaxEdge === item.value ? 'is-active' : ''}}"
            data-edge="{{item.value}}"
            bindtap="handleSelectEdgePreset"
          >
            {{item.label}}
          </view>
        </block>
      </view>
      <view class="edge-picker-actions">
        <view class="edge-picker-btn edge-picker-custom" bindtap="handleOpenCustomEdgeInput">自定义</view>
        <view class="edge-picker-btn edge-picker-close" bindtap="handleCloseEdgePicker">关闭</view>
      </view>
    </view>
  </view>
  <view wx:if="{{showEdgePicker}}" class="edge-picker-mask" bindtap="handleCloseEdgePicker"></view>

  <view class="status-row brand-panel">
    <view class="status-chip">
      <text class="status-label">工具</text>
      <text class="status-value">{{currentToolLabel}}</text>
    </view>
    <view class="status-chip status-color-chip" bindtap="handleOpenColorPicker">
      <view class="status-color-dot" style="background: {{selectedColorHex}};"></view>
      <text class="status-value">{{selectedColorCode}}</text>
      <text class="status-color-arrow">▾</text>
    </view>
    <view class="status-chip status-history-chip">
      <button
        class="status-action-btn {{!canUndo ? 'is-disabled' : ''}}"
        disabled="{{!canUndo}}"
        bindtap="handleUndo"
      >
        <view class="{{iconFontReady ? 'status-action-icon iconfont ri-arrow-go-back-line' : 'status-action-icon status-action-icon-fallback'}}">{{iconFontReady ? '' : '↶'}}</view>
        <text>撤销</text>
      </button>
      <button
        class="status-action-btn {{!canRedo ? 'is-disabled' : ''}}"
        disabled="{{!canRedo}}"
        bindtap="handleRedo"
      >
        <view class="{{iconFontReady ? 'status-action-icon iconfont ri-arrow-go-forward-line' : 'status-action-icon status-action-icon-fallback'}}">{{iconFontReady ? '' : '↷'}}</view>
        <text>重做</text>
      </button>
      <text class="status-history-text">{{historyText}}</text>
    </view>
  </view>

  <view wx:if="{{viewMode === 'edit'}}" class="tool-rail brand-panel">
    <scroll-view class="tool-scroll" scroll-x="true" enable-flex="true" show-scrollbar="false">
      <view class="tool-inline">
        <view class="tool-chip {{currentTool === 'paint' ? 'is-active' : ''}}" data-tool="paint" bindtap="handleSwitchTool">
          <text class="tool-emoji">✎</text>
          <text>画笔</text>
        </view>
        <view class="tool-chip tool-erase {{currentTool === 'erase' ? 'is-active' : ''}}">
          <view class="tool-erase-main" data-tool="erase" bindtap="handleSwitchTool">
            <text class="tool-emoji">⌫</text>
            <text>{{eraserMode === 'flood' ? '大橡皮' : '橡皮'}}</text>
          </view>
          <view class="tool-erase-more" catchtap="handleToggleEraserMenu">▾</view>
        </view>
        <view class="tool-chip {{currentTool === 'pick' ? 'is-active' : ''}}" data-tool="pick" bindtap="handleSwitchTool">
          <text class="tool-emoji">◎</text>
          <text>取色</text>
        </view>
        <view class="tool-chip {{currentTool === 'bucket' ? 'is-active' : ''}}" data-tool="bucket" bindtap="handleSwitchTool">
          <text class="tool-emoji">▣</text>
          <text>油漆桶</text>
        </view>
        <view class="tool-chip tool-action" data-action="denoise" bindtap="handleQuickAction">
          <text class="tool-emoji">◇</text>
          <text>去杂色</text>
        </view>
        <view class="tool-chip tool-action" data-action="replaceColor" bindtap="handleQuickAction">
          <text class="tool-emoji">↺</text>
          <text>批量换色</text>
        </view>
        <view class="tool-chip tool-action tool-danger" data-action="clearCanvas" bindtap="handleQuickAction">
          <text class="tool-emoji">✕</text>
          <text>清空</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <view class="canvas-panel brand-panel">
    <view
      class="canvas-stage"
      catchtouchmove="handleStageTouchMove"
    >
      <canvas
        canvas-id="editorCanvas"
        class="editor-canvas"
        width="{{canvasWidth}}"
        height="{{canvasHeight}}"
        catchtouchstart="handleCanvasTouchStart"
        catchtouchmove="handleCanvasTouchMove"
        catchtouchend="handleCanvasTouchEnd"
        catchtouchcancel="handleCanvasTouchEnd"
      ></canvas>
      <view wx:if="{{showScaleOverlay}}" class="scale-overlay">{{scaleText}}</view>
      <view wx:if="{{showMoveShapeOverlay}}" class="move-shape-overlay">{{moveShapeDeltaText}}</view>
      <view wx:if="{{!hasEditableGrid}}" class="canvas-empty">
        <text>暂未加载可编辑图纸</text>
        <text class="canvas-empty-sub">请返回创作页重新生成后再试</text>
      </view>
    </view>
  </view>

  <view class="view-tools-row brand-panel">
    <view class="view-tool-title">视图</view>
    <scroll-view class="view-tool-scroll" scroll-x="true" enable-flex="true" show-scrollbar="false">
      <view class="view-tool-inline">
        <view class="view-tool-chip {{currentTool === 'move' ? 'is-active' : ''}}" data-tool="move" bindtap="handleSwitchTool">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-drag-move-2-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '✥'}}</view>
          <text>拖拽</text>
        </view>
        <view class="view-tool-chip {{currentTool === 'moveShape' ? 'is-active' : ''}}" data-tool="moveShape" bindtap="handleSwitchTool">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-focus-3-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '⤢'}}</view>
          <text>移动图案</text>
        </view>
        <view class="view-tool-chip {{showGridLines ? 'is-active' : ''}}" data-action="toggleGrid" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-grid-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '#'}}</view>
          <text>网格</text>
        </view>
        <view class="view-tool-chip {{showColorCodeInEdit ? 'is-active' : ''}}" data-action="toggleColorCode" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-hashtag' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '◍'}}</view>
          <text>色号</text>
        </view>
        <view class="view-tool-chip {{showLocatorLines ? 'is-active' : ''}}" data-action="toggleLocator" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-crosshair-2-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '⊞'}}</view>
          <text>定位线</text>
        </view>
        <view class="view-tool-chip" data-action="mirror" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-flip-horizontal-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '⇋'}}</view>
          <text>镜像</text>
        </view>
        <view class="view-tool-chip" data-action="center" bindtap="handleQuickAction">
          <view class="{{iconFontReady ? 'view-tool-icon iconfont ri-focus-2-line' : 'view-tool-icon view-tool-icon-fallback'}}">{{iconFontReady ? '' : '◎'}}</view>
          <text>居中</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <view wx:if="{{viewMode === 'edit' && currentTool === 'moveShape'}}" class="move-shape-tip brand-panel">
    点击已填色格子后拖动，可整体移动图案
  </view>



  <view wx:if="{{viewMode === 'edit' && beadStats.length}}" class="editor-bead-panel brand-panel">
    <view class="editor-bead-head" bindtap="handleToggleBeadStats">
      <view class="editor-bead-title">色号统计（共 {{beadStats.length}} 种颜色）</view>
      <view class="editor-bead-toggle">{{showAllBeadStats ? '收起 ▲' : '展开 ▼'}}</view>
    </view>
    <scroll-view wx:if="{{!showAllBeadStats}}" class="editor-bead-preview-scroll" scroll-x="true" enable-flex="true">
      <view class="editor-bead-row">
        <block wx:for="{{beadStats}}" wx:key="index">
          <view
            class="editor-bead-item editor-bead-item-preview {{beadHighlightIndex === item.index ? 'is-active' : ''}}"
            data-index="{{item.index}}"
            bindtap="handleSelectBeadColor"
          >
            <view class="editor-bead-color" style="background: {{item.hex}};"></view>
            <text class="editor-bead-code">{{item.code}}</text>
            <text class="editor-bead-count">{{item.count}} 颗</text>
          </view>
        </block>
      </view>
    </scroll-view>
    <scroll-view wx:if="{{showAllBeadStats}}" class="editor-bead-full-scroll" scroll-y="true" enable-flex="true">
      <view class="editor-bead-grid">
        <block wx:for="{{beadStats}}" wx:key="index">
          <view
            class="editor-bead-item editor-bead-item-full {{beadHighlightIndex === item.index ? 'is-active' : ''}}"
            data-index="{{item.index}}"
            bindtap="handleSelectBeadColor"
          >
            <view class="editor-bead-color" style="background: {{item.hex}};"></view>
            <text class="editor-bead-code">{{item.code}}</text>
            <text class="editor-bead-count">{{item.count}} 颗</text>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <view wx:if="{{viewMode === 'edit'}}" class="palette-panel brand-panel">
    <view class="palette-title">已用色</view>
    <scroll-view class="used-scroll" scroll-x="true" enable-flex="true">
      <view class="used-row">
        <block wx:for="{{usedPalette}}" wx:key="index">
          <view
            class="color-chip {{selectedColorIndex === item.index ? 'is-active' : ''}}"
            data-index="{{item.index}}"
            bindtap="handlePickColor"
          >
            <view class="color-dot" style="background: {{item.hex}};"></view>
            <text class="color-code">{{item.code}}</text>
          </view>
        </block>
      </view>
    </scroll-view>

    <view class="palette-title full-title">MARD 全量色卡</view>
    <scroll-view class="full-scroll" scroll-y="true" show-scrollbar="true">
      <view class="full-grid">
        <block wx:for="{{fullPalette}}" wx:key="index">
          <view
            class="full-item {{selectedColorIndex === item.index ? 'is-active' : ''}}"
            data-index="{{item.index}}"
            bindtap="handlePickColor"
          >
            <view class="full-dot" style="background: {{item.hex}};"></view>
            <text class="full-code">{{item.code}}</text>
          </view>
        </block>
      </view>
    </scroll-view>
  </view>

  <canvas
    canvas-id="exportCanvas"
    width="{{exportCanvasSize}}"
    height="{{exportCanvasSize}}"
    style="position: fixed; left: -9999px; top: -9999px; width: {{exportCanvasSize}}px; height: {{exportCanvasSize}}px;"
  ></canvas>

  <view wx:if="{{showColorPicker}}" class="color-picker-mask" bindtap="handleCloseColorPicker">
    <view class="color-picker-panel brand-panel" catchtap="noop">
      <view class="color-picker-title">选择颜色</view>
      <view class="color-picker-sub">已使用颜色</view>
      <scroll-view class="color-picker-used-scroll" scroll-x="true" enable-flex="true">
        <view class="used-row">
          <block wx:for="{{usedPalette}}" wx:key="index">
            <view
              class="color-chip {{selectedColorIndex === item.index ? 'is-active' : ''}}"
              data-index="{{item.index}}"
              bindtap="handlePickColor"
            >
              <view class="color-dot" style="background: {{item.hex}};"></view>
              <text class="color-code">{{item.code}}</text>
            </view>
          </block>
        </view>
      </scroll-view>
      <view class="color-picker-sub color-picker-sub-full">MARD 全量色卡</view>
      <scroll-view class="color-picker-full-scroll" scroll-y="true" show-scrollbar="true">
        <view class="full-grid">
          <block wx:for="{{fullPalette}}" wx:key="index">
            <view
              class="full-item {{selectedColorIndex === item.index ? 'is-active' : ''}}"
              data-index="{{item.index}}"
              bindtap="handlePickColor"
            >
              <view class="full-dot" style="background: {{item.hex}};"></view>
              <text class="full-code">{{item.code}}</text>
            </view>
          </block>
        </view>
      </scroll-view>
      <view class="color-picker-footer">
        <button class="color-picker-close-btn" bindtap="handleCloseColorPicker">关闭</button>
      </view>
    </view>
  </view>
</view>
